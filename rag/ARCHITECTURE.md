# RAG 아키텍처

> **이 문서는 Bizi RAG 서비스의 상세 아키텍처를 설명합니다.**
> 개발 가이드는 [CLAUDE.md](./CLAUDE.md)를 참조하세요.

## Agentic RAG 흐름

```
사용자 입력
    │
    ↓
┌─────────────────────────────────────────────────────────────┐
│                      메인 라우터                             │
│  - 질문 분석 및 도메인 분류                                    │
│  - 에이전트 조율 및 응답 통합                                  │
│  - 평가 결과에 따른 재요청 처리                                │
└────────────────────────┬────────────────────────────────────┘
                         │
        ┌────────────────┼────────────────┐
        ↓                ↓                ↓
┌───────────────┐ ┌───────────────┐ ┌───────────────┐
│ 창업 및 지원   │ │ 재무 및 세무   │ │ 인사 및 노무   │
│   에이전트     │ │   에이전트     │ │   에이전트     │
│               │ │               │ │               │
│ - 창업 절차    │ │ - 세금 안내    │ │ - 근로 상담    │
│ - 지원사업    │ │ - 회계 가이드   │ │ - 채용/해고    │
│ - 마케팅      │ │ - 재무 분석    │ │ - 법률 자문    │
└───────┬───────┘ └───────┬───────┘ └───────┬───────┘
        │                 │                 │
        └────────────────┬┴─────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                      평가 에이전트                           │
│  - 답변 품질 평가 (정확성, 완성도, 관련성)                    │
│  - 재요청 필요 여부 판단                                     │
│  - 피드백 생성                                               │
└────────────────────────┬────────────────────────────────────┘
                         │
              ┌──────────┴──────────┐
              │ 품질 충족?           │
              │                     │
         [Yes]│                [No] │
              ↓                     ↓
┌─────────────────────┐   ┌─────────────────────┐
│  Action Executor    │   │ 메인 라우터로 재요청 │
│  (필요시 문서 생성)  │   │  (피드백 포함)      │
└──────────┬──────────┘   └─────────────────────┘
           │
           ↓
┌─────────────────────────────────────────────────────────────┐
│                  RAGAS 정량 평가 (선택)                       │
│  - Faithfulness (사실 일관성)                                │
│  - Answer Relevancy (답변 관련성)                            │
│  - Context Precision (컨텍스트 정밀도)                       │
│  - 로그 기록 (logs/ragas.log)                               │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ↓
                     최종 응답
```

## 통신 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                      Frontend (React + Vite)                    │
│                    localhost:5173                               │
└───────────────┬─────────────────────────────┬───────────────────┘
                │ axios (REST API)            │ axios (직접 통신)
                │ (인증, 사용자, 기업)         │ (채팅, AI 응답)
                ↓                             ↓
┌───────────────────────────┐    ┌─────────────────────────────────┐
│   Backend (FastAPI)       │    │      RAG Service (FastAPI)      │
│   localhost:8000          │    │      localhost:8001             │
│                           │    │                                 │
│ - Google OAuth2 인증      │    │ - 메인 라우터                    │
│ - 사용자/기업 관리         │    │ - 3개 전문 에이전트              │
│ - 상담 이력 저장           │    │ - 평가 에이전트                 │
│ - 일정 관리               │    │ - Action Executor               │
└───────────────┬───────────┘    └───────────┬─────────────────────┘
                │                             │
                ↓                             ↓
        ┌───────────────┐           ┌─────────────────────┐
        │    MySQL      │           │     ChromaDB        │
        │  final_test   │           │   (Vector DB)       │
        └───────────────┘           └─────────────────────┘
```

## 벡터DB 구조

```
ChromaDB
├── startup_funding_db/          # 창업/지원/마케팅 전용
│   ├── 창업진흥원 자료
│   ├── 중소벤처기업부 자료
│   ├── 기업마당 공고
│   ├── K-Startup 공고
│   └── 마케팅 가이드
│
├── finance_tax_db/              # 재무/세무 전용
│   ├── 국세청 자료
│   ├── 세법 정보
│   └── 회계 기준
│
├── hr_labor_db/                 # 인사/노무/법률 전용
│   ├── 근로기준법
│   ├── 근로기준법 시행령
│   ├── 근로기준법 시행규칙
│   ├── 상법
│   ├── 민법
│   └── 지식재산권법
│
└── law_common_db/               # 법령/법령해석 (공통)
    ├── 법령 원문
    └── 법령 해석례
```

## 에이전트 상세

### 1. 메인 라우터

**역할**: 질문 분류, 에이전트 조율, 평가 결과에 따른 재요청

```python
class MainRouter:
    """
    사용자 질문을 분석하여 적절한 에이전트로 라우팅
    복합 질문 시 여러 에이전트 병렬 호출 후 응답 통합
    평가 에이전트의 피드백에 따라 재요청 처리
    """

    def route(self, query: str) -> list[str]:
        """도메인 분류 후 담당 에이전트 목록 반환"""
        pass

    def aggregate(self, responses: list[AgentResponse]) -> str:
        """여러 에이전트 응답 통합"""
        pass

    def retry_with_feedback(self, feedback: EvaluationFeedback) -> str:
        """평가 피드백에 따른 재요청"""
        pass
```

### 2. 창업 및 지원 에이전트

**담당 도메인**: 창업, 지원사업, 마케팅
**데이터 소스**: 창업진흥원, 중소벤처기업부, 기업마당 API, K-Startup API

**주요 기능**:
- 사업자 등록 절차 안내
- 법인 설립 가이드
- 업종별 인허가 정보
- 지원사업 검색/필터
- 기업 조건 매칭
- 마케팅 전략 조언

### 3. 재무 및 세무 에이전트

**담당 도메인**: 세무, 회계, 재무
**데이터 소스**: 국세청 자료, 세법

**주요 기능**:
- 세금 종류별 안내
- 신고/납부 일정
- 세금 계산 가이드
- 회계 기초 안내
- 재무제표 분석

### 4. 인사 및 노무 에이전트

**담당 도메인**: 노무, 인사, 법률
**데이터 소스**: 근로기준법, 상법, 민법, 지식재산권법

**주요 기능**:
- Hierarchical RAG (법령 계층 검색)
- 채용/해고 상담
- 근로시간/휴가 안내
- 임금/퇴직금 계산
- 계약법 가이드
- 지식재산권 안내

### 5. 평가 에이전트

**역할**: 답변 품질 평가 및 재요청 판단

**평가 기준**:
- 정확성: 제공된 정보가 사실에 부합하는지
- 완성도: 질문에 대해 충분히 답변했는지
- 관련성: 질문 의도에 맞는 답변인지
- 출처 명시: 법령/규정 인용 시 출처가 있는지

```python
class Evaluator:
    """
    답변 품질을 평가하고 재요청 여부를 판단
    """

    def evaluate(self, query: str, response: str) -> EvaluationResult:
        """
        답변 품질 평가
        Returns: EvaluationResult(score, passed, feedback)
        """
        pass

    def should_retry(self, result: EvaluationResult) -> bool:
        """재요청 필요 여부 판단 (threshold 기반)"""
        pass
```

### 6. Action Executor

**역할**: 문서 생성 (PDF, HWP)

**생성 가능 문서**:
- 근로계약서
- 취업규칙
- 연차관리대장
- 급여명세서
- 사업계획서 템플릿

## 이중 평가 체계

RAG 시스템은 두 가지 평가 방식을 지원합니다:

| 구분 | LLM 기반 평가 (evaluator.py) | RAGAS 정량 평가 (evaluation/) |
|------|------------------------------|-------------------------------|
| 방식 | LLM이 5개 기준으로 채점 | RAGAS 라이브러리 메트릭 |
| 메트릭 | 검색품질, 정확성, 완성도, 관련성, 출처 (각 20점) | Faithfulness, Answer Relevancy, Context Precision, Context Recall |
| 용도 | 실시간 품질 판단 및 재요청 | 정량적 품질 추적 및 분석 |
| 실행 | 항상 실행 | 설정 활성화 시 (`ENABLE_RAGAS_EVALUATION=true`) |
| 로그 | logs/chat.log | logs/ragas.log (JSON Lines) |

## 데이터 흐름 예시

### 단일 도메인 질문
```
Q: "부가세 신고 기한이 언제인가요?"

1. 메인 라우터 → 도메인 분류: finance_tax
2. 재무 및 세무 에이전트 → RAG 검색 → 답변 생성
3. 평가 에이전트 → 품질 평가 (PASS)
4. 최종 응답 반환
```

### 복합 도메인 질문
```
Q: "창업하려는데 사업자등록 방법과 초기 세무 처리 알려주세요"

1. 메인 라우터 → 도메인 분류: [startup_funding, finance_tax]
2. 병렬 처리:
   - 창업 및 지원 에이전트 → 사업자등록 안내
   - 재무 및 세무 에이전트 → 초기 세무 처리 안내
3. 메인 라우터 → 응답 통합
4. 평가 에이전트 → 품질 평가 (PASS)
5. 최종 응답 반환
```

### 재요청 발생 케이스
```
Q: "직원 해고 시 퇴직금 계산법?"

1. 메인 라우터 → 도메인 분류: hr_labor
2. 인사 및 노무 에이전트 → 답변 생성 (불완전)
3. 평가 에이전트 → 품질 평가 (FAIL: 완성도 부족)
4. 메인 라우터 → 피드백과 함께 재요청
5. 인사 및 노무 에이전트 → 보완된 답변 생성
6. 평가 에이전트 → 품질 평가 (PASS)
7. 최종 응답 반환
```
