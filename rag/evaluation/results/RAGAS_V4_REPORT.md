# RAGAS v4 평가 리포트

> 평가일: 2026-02-18
> 데이터셋: `qa_test/ragas_dataset_v4.jsonl` (80문항, 12 페르소나)
> 평가 환경: CPU 모드 (bge-m3 로컬, Reranking OFF, MultiQuery 1개)
> 결과 파일:
>   - 1차: `rag/evaluation/results/ragas_v4_results.json`
>   - 2차 (개선 후): `rag/evaluation/results/ragas_v4_improved.json`

---

## 1. 핵심 요약

### 1차 → 2차 개선 비교 (타임아웃 제외 기준)

| 메트릭 | 1차 (68문항) | 2차 (60문항) | 변화 |
|--------|-------------|-------------|------|
| **Faithfulness** | 0.7573 | **0.8092** | **+0.05 향상** |
| Answer Relevancy | 0.9610 | 0.9550 | -0.006 (동일) |
| Context Recall | 0.6240 | 0.6131 | -0.011 (동일) |

> **Faithfulness가 0.76 → 0.81로 유의미하게 향상.** Grounding 프롬프트 강화가 핵심 기여.
> Answer Relevancy와 Context Recall은 동일 수준 유지.

### 전체 80문항 (참고용)

| 메트릭 | 1차 | 2차 | 설명 |
|--------|-----|-----|------|
| Faithfulness | 0.6437 | 0.6069 | 타임아웃 증가로 전체 평균 하락 |
| Answer Relevancy | 0.8169 | 0.7162 | 타임아웃 증가로 전체 평균 하락 |
| Context Precision | 0.9546 (n=29) | 0.9466 (n=21) | 동일 수준 |
| Context Recall | 0.6444 | 0.6447 | 동일 수준 |

> 전체 평균 하락은 **타임아웃 12건→20건 증가** 때문이며, 유효 문항만 비교하면 개선됨.
> 타임아웃 증가 원인은 2차에서 적용했던 엄격한 재시도 설정(이후 원복 완료).

---

## 2. 적용한 개선사항

### 유지 (최종 반영)

| # | 개선 내용 | 파일 | 효과 |
|---|----------|------|------|
| 1 | **Grounding 프롬프트 강화** | `prompts.py` | Faithfulness +0.05 (핵심) |
| | - "추론/유추 절대 금지" 명시 | 4개 도메인 + 통합 프롬프트 | LLM의 자체 지식 사용 억제 |
| | - "반드시 직접 인용" (의역 금지) | | 컨텍스트 기반 답변 강화 |
| | - "문장마다 [번호] 출처 표기" | | 출처 추적성 향상 |
| 2 | **컨텍스트 길이 확대** 2000→4000 | `settings.py` | 긴 법률 조문 잘림 방지 |
| 3 | **최대 검색 문서 수** 10→15 | `settings.py` | 복합 도메인 문서 부족 해소 |
| 4 | **Multi-Query 다양성 강화** | `prompts.py` | 법규/절차/예외 3관점 쿼리 |
| 5 | **법률 보충 검색 확대** | `legal_supplement.py` | 검사 범위 5→10건, 내용 500→1000자 |
| 6 | **BM25 배치 로딩** | `chroma.py` | law_common 55,723건 로딩 성공 |

### 원복 (CPU 모드 비적합)

| # | 설정 | 적용값 | 원복값 | 원복 사유 |
|---|------|-------|-------|----------|
| 1 | `max_retry_level` | 3 | **2** | Level 3(인접 도메인 검색)이 CPU에서 타임아웃 유발 |
| 2 | `min_keyword_match_ratio` | 0.5 | **0.3** | 엄격한 임계값이 과도한 재시도 유발 |
| 3 | `min_avg_similarity_score` | 0.6 | **0.5** | 엄격한 임계값이 과도한 재시도 유발 |

> 원복 3개 설정은 **GPU 배포(RunPod) 후** 재적용 예정.
> GPU 모드에서는 Reranking/MultiQuery 3개 등이 활성화되어 재시도 부담이 줄어들기 때문.

---

## 3. Part별 성능 비교 (타임아웃 제외)

| Part | 유형 | 문항 | 1차 TO | 2차 TO | 1차 Faith | 2차 Faith | 변화 |
|------|------|------|--------|--------|-----------|-----------|------|
| Part 1 | 단일 도메인 | 20 | 0건 | 2건 | 0.7693 | 0.7601 | -0.01 |
| Part 2 | 2-도메인 복합 | 30 | 3건 | 3건 | 0.7650 | **0.8389** | **+0.07** |
| Part 3 | 3-도메인 복합 | 22 | 7건 | 9건 | 0.6879 | **0.7973** | **+0.11** |
| Part 4 | 4-도메인 복합 | 8 | 2건 | 6건 | 0.8561 | **0.9285** | **+0.07** |

**분석:**
- **Part 2~4 복합 도메인에서 Faithfulness 대폭 향상** (최대 +0.11)
- 특히 Part 3(3-도메인)이 0.69 → 0.80으로 크게 개선
- Part 4는 0.93으로 Excellent 수준 도달
- Part 1(단일 도메인)은 이미 양호하여 변화 미미

---

## 4. 품질 등급 분포 비교 (타임아웃 제외)

### Faithfulness 분포

| 등급 | 범위 | 1차 (68건) | 2차 (60건) | 변화 |
|------|------|-----------|-----------|------|
| Excellent | 0.9 ~ 1.0 | 33건 (48.5%) | 34건 (**56.7%**) | **+8.2pp** |
| Good | 0.7 ~ 0.9 | 8건 (11.8%) | 11건 (**18.3%**) | **+6.5pp** |
| Medium | 0.5 ~ 0.7 | 16건 (23.5%) | 5건 (8.3%) | -15.2pp |
| Low | 0.3 ~ 0.5 | 6건 (8.8%) | 6건 (10.0%) | +1.2pp |
| Very Low | 0.0 ~ 0.3 | 5건 (7.4%) | 4건 (6.7%) | -0.7pp |

> **Good 이상 비율: 60.3% → 75.0% (+14.7pp)**
> **Excellent 비율: 48.5% → 56.7% (+8.2pp)**
> Medium 구간이 대폭 감소 → Good/Excellent로 이동

### Answer Relevancy 분포

| 등급 | 범위 | 1차 | 2차 |
|------|------|-----|-----|
| Excellent | 0.9 ~ 1.0 | 68건 (100%) | 60건 (100%) |

> 타임아웃만 아니면 답변 관련성은 전부 0.9 이상 (양쪽 모두 매우 우수)

### Context Recall 분포 (2차)

| 등급 | 범위 | 건수 | 비율 |
|------|------|------|------|
| Excellent | 0.9 ~ 1.0 | 14건 | 23.3% |
| Good | 0.7 ~ 0.9 | 10건 | 16.7% |
| Medium | 0.5 ~ 0.7 | 17건 | 28.3% |
| Low | 0.3 ~ 0.5 | 11건 | 18.3% |
| Very Low | 0.0 ~ 0.3 | 8건 | 13.3% |

> Context Recall은 1차와 유사한 분포. GPU 배포 후 Reranking/MultiQuery 활성화로 개선 예상.

---

## 5. 타임아웃 분석

### 2차 타임아웃 20건

CPU 모드에서 300초 타임아웃 초과로 답변 생성에 실패한 문항입니다.

- **1차에서만 발생 (7건, 2차에서 해결됨):** #23, #33, #35, #52, #57, #65, #67
- **양쪽 모두 발생 (5건):** #54, #60, #68, #74, #78
- **2차에서 새로 발생 (15건):** #6, #15, #28, #29, #42, #51, #61, #63, #66, #69, #71, #73, #77, #79, #80

**2차 타임아웃 증가 원인:**
- `max_retry_level` 2→3, `min_keyword_match_ratio` 0.3→0.5, `min_avg_similarity_score` 0.5→0.6
- 엄격한 임계값이 거의 모든 검색을 FAIL 판정 → 3단계까지 재시도 → 300초 초과
- **해결:** 해당 3개 설정을 원복하여 타임아웃 원인 제거 완료

**해결된 7건의 의미:**
- 1차 타임아웃이었던 7건이 2차에서 성공적으로 답변 생성
- BM25 배치 로딩 + 컨텍스트 길이 확대 + Multi-Query 다양성 강화 효과

---

## 6. 저품질 문항 (Faithfulness < 0.3, 2차 타임아웃 제외)

| # | Faith | Rel | Recall | 문항 |
|---|-------|-----|--------|------|
| 17 | 0.25 | 0.95 | 1.00 | 시니어 케어 플랫폼 — 노인복지법상 노인복지시설 종류와 설치 기준... |
| 20 | 0.14 | 0.95 | 0.22 | AI 기반 학습 플랫폼 — AI 생성 학습 콘텐츠의 저작권 문제... |
| 21 | 0.12 | 0.95 | 0.33 | 친환경 패키징 제조회사 — 직원 25명 연말정산, 식대·차량유지비... |
| 47 | 0.00 | 0.95 | 0.50 | 반려동물 용품 온라인몰 — 상표 등록 절차와 미등록 위험... |

**1차 대비 개선:**
- 1차 5건 → 2차 4건으로 감소
- #5(인쇄회사 재고용)가 0.10 → 1.00으로 대폭 개선
- #7(플라워샵 4대보험)이 0.00 → 0.33으로 개선
- #47은 여전히 0.00 — 상표 등록 관련 문서 부족 (벡터DB 보강 필요)

**패턴:** Relevancy는 높지만 Faithfulness가 낮음 → LLM이 컨텍스트 대신 자체 지식으로 답변

---

## 7. 평가 환경 제약

이번 평가는 **CPU 모드**에서 실행되었으며, 다음 기능이 비활성화 상태입니다:

| 기능 | 상태 | GPU 모드 시 | 예상 효과 |
|------|------|------------|----------|
| Cross-Encoder Reranking | **OFF** | ON | Faithfulness +0.03~0.05 |
| Context Compression | **OFF** | ON | Faithfulness +0.02~0.03 |
| Post-Eval Retry | **OFF** | ON | 저품질 문항 재시도 |
| LLM Evaluation | **OFF** | ON | 자체 품질 평가 |
| Multi-Query | **1개** | 3개 | Context Recall +0.05~0.10 |
| 엄격한 임계값 | **원복** | 적용 가능 | 재시도 품질 향상 |
| max_retry_level | **2** | 3 | 인접 도메인 검색 |

> GPU 모드(RunPod) 배포 후 **Faithfulness 0.85+, Context Recall 0.70+** 달성 가능 예상

---

## 8. 최종 결론 및 향후 계획

### 이번 개선 성과

| 지표 | 달성 |
|------|------|
| Faithfulness | 0.76 → **0.81** (목표 0.8 달성) |
| Answer Relevancy | 0.96 유지 (목표 0.9 초과) |
| Context Recall | 0.62 유지 (목표 0.7 미달, GPU 후 개선 예정) |
| Excellent 비율 | 48.5% → **56.7%** (+8.2pp) |
| Good+ 비율 | 60.3% → **75.0%** (+14.7pp) |

### GPU 배포 후 즉시 적용 (단기)

1. **Reranking + Context Compression 활성화** → Faithfulness 추가 향상
2. **Multi-Query 3개 활성화** → Context Recall 향상
3. **엄격한 임계값 재적용** (keyword 0.5, similarity 0.6, retry level 3)
4. **타임아웃 확장** → 복합 도메인 질문용 450초

### 데이터 보강 (중기)

5. **상표/지식재산권 문서 보강** → #47 등 저품질 문항 해결
6. **법률 보충 검색 K값 확대** (3→5) → 법률 관련 복합 질문 개선
7. **AI 저작권 관련 문서 추가** → #20 등 신규 분야 커버

### 아키텍처 개선 (장기)

8. **Query Decomposition** → 복합 질문을 하위 질문으로 분해 후 개별 검색
9. **Chunk 크기 최적화** → 현재 청킹 전략 대비 작은 청크로 정밀 검색

---

## 부록 A: 메트릭 설명

| 메트릭 | 의미 | 이상적 값 |
|--------|------|----------|
| **Faithfulness** | 답변 내용이 검색된 문서(컨텍스트)에 근거하는지. 낮으면 환각(hallucination) 가능성. | >= 0.8 |
| **Answer Relevancy** | 답변이 질문에 적절하고 관련 있는지. | >= 0.9 |
| **Context Precision** | 검색된 문서 중 실제로 답변에 필요한 문서의 비율. | >= 0.8 |
| **Context Recall** | 정답(ground_truth)에 필요한 정보가 검색 결과에 포함되었는지. | >= 0.7 |

## 부록 B: 변경 파일 목록

| 파일 | 변경 내용 |
|------|----------|
| `rag/utils/prompts.py` | 4개 도메인 + 통합 프롬프트 Grounding 강화, Multi-Query 다양성 강화 |
| `rag/utils/config/settings.py` | format_context_length 4000, max_retrieval_docs 15 |
| `rag/utils/legal_supplement.py` | DOC_CHECK_LIMIT 10, DOC_CONTENT_LIMIT 1000 |
| `rag/vectorstores/chroma.py` | get_domain_documents 배치 로딩 (5000건 단위) |
