# =============================================================================
# RAG Service 프로덕션 이미지 (멀티스테이지 빌드)
# Stage 1: build-essential + pip install + 모델 다운로드
# Stage 2: python:3.10-slim (런타임만)
# =============================================================================

# --- Stage 1: Build ---
FROM python:3.10-slim AS builder

WORKDIR /app

# 빌드 도구 설치 (C 확장 컴파일용)
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Python 의존성 설치
RUN pip install --no-cache-dir --upgrade pip
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# BGE-M3 임베딩 모델 프리다운로드 (이미지에 포함)
RUN python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('BAAI/bge-m3')"

# bge-reranker-base 모델 프리다운로드
RUN python -c "from sentence_transformers import CrossEncoder; CrossEncoder('BAAI/bge-reranker-base')"

# --- Stage 2: Runtime ---
FROM python:3.10-slim

WORKDIR /app

# 런타임 라이브러리만 설치 (build-essential 제외 → ~200MB 절감)
RUN apt-get update && apt-get install -y --no-install-recommends \
    libgomp1 \
    && rm -rf /var/lib/apt/lists/*

# Stage 1에서 설치된 Python 패키지 복사
COPY --from=builder /usr/local/lib/python3.10/site-packages /usr/local/lib/python3.10/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

# Stage 1에서 다운로드된 모델 캐시 복사
COPY --from=builder /root/.cache /root/.cache

# GPU 지원 (NVIDIA Container Toolkit 필요)
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility

# 소스 코드 복사
COPY . .

EXPOSE 8001

# 단일 워커: BGE-M3(~1.5GB) + bge-reranker-base(~300MB) 메모리 제한
# FastAPI async로 동시 요청 처리 (병목은 OpenAI API I/O)
CMD ["uvicorn", "main:app", \
     "--host", "0.0.0.0", \
     "--port", "8001", \
     "--timeout-keep-alive", "120"]
