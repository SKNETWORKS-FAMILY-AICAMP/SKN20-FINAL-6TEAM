# RAGAS V4 평가 보고서

> 평가일: 2026-02-21
> 평가 모델: **gpt-4.1-mini** (RAGAS 채점용)
> 데이터셋: `qa_test/ragas_dataset_v4.jsonl` (80문항, ground_truth 포함)
> 임베딩/리랭킹: RunPod GPU (BAAI/bge-m3 + bge-reranker-base)
> 결과 파일: `rag/evaluation/results/ragas_v4_gpt41mini.json`

---

## 1. 평가 결과 요약

| 메트릭 | 점수 | 유효 샘플 | 설명 |
|--------|------|----------|------|
| **Faithfulness** | **0.4723** | 80 | 답변이 검색된 컨텍스트에 충실한가 |
| **Answer Relevancy** | **0.6752** | 80 | 답변이 질문에 직접 관련 있는가 |
| **Context Precision** | **0.6567** | 80 | 검색된 문서가 정확하게 상위 랭킹되었는가 |
| **Context Recall** | **0.6023** | 80 | 정답에 필요한 컨텍스트가 충분히 검색되었는가 |

- 전체 80문항 중 타임아웃: **0건** (100% 응답 성공)
- 평균 응답시간: **29.6초** (중앙값 25.4초, 최대 130.9초)
- 60초 초과: **1건**

---

## 2. 이전 평가와 비교

| 메트릭 | V4 (gpt-3.5-turbo) | V4 개선 후 (gpt-4.1-mini) | 변화 |
|--------|---------------------|--------------------------|------|
| Faithfulness | 0.677 | 0.472 | -0.205 |
| Answer Relevancy | 0.523 | **0.675** | **+0.152** |
| Context Precision | 0.916 | 0.657 | -0.259 |
| Context Recall | 0.743 | 0.602 | -0.141 |

### 중요: 두 결과는 직접 비교 불가

이번 평가는 동시에 **2가지를 변경**했습니다:

1. **RAG 프롬프트/파라미터 개선** (P1~P9, 아래 3장 참조)
2. **RAGAS 채점 모델 변경** (gpt-3.5-turbo → gpt-4.1-mini)

gpt-4.1-mini는 gpt-3.5-turbo보다 **더 엄격한 평가자**입니다:
- **Faithfulness**: 컨텍스트에 없는 주장을 더 정확히 감지 → 점수 하락
- **Context Precision**: 문서 관련성을 더 엄격하게 판단 → 점수 하락
- **Context Recall**: ground_truth 커버 여부를 더 세밀하게 판단 → 점수 하락

**Answer Relevancy**만 +0.152 개선된 것은 프롬프트 개선(P2 답변 집중, P3 멀티도메인 합성)의 **순수 효과**입니다. 엄격한 평가자에서도 개선이 나타났으므로 실제 개선 폭은 이보다 클 수 있습니다.

---

## 3. 적용된 RAG 개선 사항 (P1~P9)

### Phase 1: 프롬프트 개선

| 항목 | 변경 내용 | 대상 파일 |
|------|----------|----------|
| **P1** | 4개 도메인 프롬프트에 Grounding 강화 ("참고 자료만 사용" 최우선 규칙) | `rag/utils/prompts.py` |
| **P2** | 4개 도메인 프롬프트에 답변 집중 지시 추가 (800자/1500자 제한) | `rag/utils/prompts.py` |
| **P3** | MULTI_DOMAIN_SYNTHESIS_PROMPT 전면 개편 (7개 통합 원칙) | `rag/utils/prompts.py` |

### Phase 2: 파라미터 튜닝

| 항목 | 변경 | 이전 → 이후 | 대상 파일 |
|------|------|------------|----------|
| **P4** | Temperature 낮추기 | 0.3 → **0.1** | `settings.py` |
| **P5** | max_tokens 제한 추가 | 없음 → **2048** | `settings.py`, `llm.py`, `generator.py` |
| **P6** | format_context_length 확대 | 2000 → **3000** | `settings.py` |
| **P9** | evaluator_context_length 확대 | 2000 → **3000** | `settings.py` |

### Phase 3: 파이프라인 수정

| 항목 | 변경 | 대상 파일 |
|------|------|----------|
| **P7** | ACTION_HINT를 context에서 system_prompt로 분리 | `generator.py` |

### Phase 4: 검색 보완

| 항목 | 변경 | 이전 → 이후 | 대상 파일 |
|------|------|------------|----------|
| **P8** | Legal supplement 범위 확대 | k=3→4, 문서확인=5→8, 내용제한=500→800 | `legal_supplement.py`, `settings.py` |

---

## 4. 점수 분포 분석

### Faithfulness (사실 충실도)

| 구간 | 건수 | 비율 |
|------|------|------|
| 0.0 (완전 불일치) | 7 | 8.8% |
| 0.01~0.29 | 14 | 17.5% |
| 0.30~0.49 | 18 | 22.5% |
| 0.50~0.69 | 24 | 30.0% |
| 0.70~0.89 | 14 | 17.5% |
| 0.90~1.00 | 3 | 3.8% |

### Answer Relevancy (답변 관련성)

| 구간 | 건수 | 비율 |
|------|------|------|
| 0.0 (무관련) | 6 | 7.5% |
| 0.01~0.29 | 0 | 0.0% |
| 0.30~0.49 | 2 | 2.5% |
| 0.50~0.69 | 26 | 32.5% |
| 0.70~0.89 | 44 | **55.0%** |
| 0.90~1.00 | 2 | 2.5% |

### Context Precision (검색 정밀도)

| 구간 | 건수 | 비율 |
|------|------|------|
| 0.0 | 6 | 7.5% |
| 0.01~0.29 | 9 | 11.3% |
| 0.30~0.49 | 10 | 12.5% |
| 0.50~0.69 | 14 | 17.5% |
| 0.70~0.89 | 9 | 11.3% |
| 0.90~1.00 | 32 | **40.0%** |

### Context Recall (검색 재현율)

| 구간 | 건수 | 비율 |
|------|------|------|
| 0.0 | 6 | 7.5% |
| 0.01~0.29 | 4 | 5.0% |
| 0.30~0.49 | 14 | 17.5% |
| 0.50~0.69 | 24 | 30.0% |
| 0.70~0.89 | 23 | 28.8% |
| 0.90~1.00 | 9 | 11.3% |

---

## 5. 주요 실패 분석

### Faithfulness=0 (7건) — 답변이 컨텍스트와 완전 불일치

| 질문 (요약) | AR | CP | CR |
|------------|-----|-----|-----|
| 전기공사 현장 안전보건교육 의무, 시간, 처벌 | 0.80 | 0.17 | 0.12 |
| 플라워샵 직원 1명 4대보험 가입의무, 보험료 부담 | 0.85 | 0.00 | 0.33 |
| 화장품 수출 부가세 영세율 적용 요건/절차 | 0.60 | 0.00 | 0.00 |
| AI 학습 플랫폼 저작권, 학생 데이터 수집 | 0.00 | 0.33 | 0.67 |
| 전기공사 일용직 퇴직공제부금, 원천징수 | 0.00 | 0.00 | 0.00 |
| 시니어케어 요양보호사 인건비 세무처리, 최저임금 | 0.85 | 0.20 | 0.75 |
| 디저트카페 아르바이트 근로계약서, 소상공인 지원 | 0.00 | 0.50 | 0.67 |

**공통 패턴**: 대부분 멀티도메인 질문(인사+세무, 법률+창업 등). 검색된 컨텍스트(CP/CR 낮음)가 부족한 상태에서 LLM이 자체 지식으로 보충 → Faithfulness=0.

### Answer Relevancy=0 (6건) — 질문과 무관한 답변

| 질문 (요약) | F | CP | CR |
|------------|-----|-----|-----|
| AI 학습 플랫폼 저작권, 학생 데이터 | 0.00 | 0.33 | 0.67 |
| 친환경 패키징 연말정산 비과세 항목 | 0.32 | 1.00 | 1.00 |
| 전기공사 일용직 퇴직공제/원천징수/4대보험 | 0.00 | 0.00 | 0.00 |
| 디저트카페 아르바이트 근로계약서/소상공인 지원 | 0.00 | 0.50 | 0.67 |
| 키즈카페 안전관리자 자격/정부 지원사업 | 0.47 | 0.00 | 0.44 |
| 콘텐츠 개발자 스톡옵션, 저작권, 에드테크 지원 | 0.33 | 1.00 | 0.33 |

**공통 패턴**: 복합 질문에서 일부만 답변하거나, 검색 실패로 관련 없는 내용 생성.

---

## 6. RAGAS 평가 인프라 개선

### strictness=1 적용

기존 RAGAS answer_relevancy 메트릭은 LLM에 `n=3`(한번에 3개 질문 생성)을 요청했으나, gpt-4.1-mini가 `n>1`을 지원하지 않아 매 항목마다 경고 발생 + 극도로 느린 채점이 발생했습니다.

| 항목 | 수정 전 | 수정 후 |
|------|---------|---------|
| 경고 | `LLM returned 1 generations instead of 3` (매 항목) | 없음 |
| 채점 시간 (추정) | ~120분 | ~40분 |
| 설정 | `answer_relevancy.strictness = 3` (기본값) | `strictness = 1` |

**수정 파일**: `rag/evaluation/ragas_evaluator.py` (line 116)

---

## 7. 향후 개선 방향

### 단기 (1주 내)

1. **동일 모델로 전후 비교**: gpt-4.1-mini 기준 개선 전 프롬프트로 baseline 측정 → 정확한 개선 효과 파악
2. **Faithfulness=0 질문 디버깅**: 7건의 실패 케이스에 대해 검색 결과와 생성 답변을 수동 검토
3. **멀티도메인 질문 강화**: Faithfulness/AR=0의 대부분이 멀티도메인 → MULTI_DOMAIN_SYNTHESIS_PROMPT 추가 개선

### 중기 (2~4주)

4. **검색 품질 개선**: Context Precision/Recall이 낮은 질문들의 검색 파이프라인 분석
5. **Hallucination 방지 강화**: Faithfulness < 0.3인 21건에 대한 패턴 분석 및 프롬프트 보강
6. **RAGAS 평가 자동화**: CI/CD에 RAGAS 회귀 테스트 통합

---

## 8. 응답 성능

| 지표 | 값 |
|------|-----|
| 평균 응답시간 | 29.6초 |
| 중앙값 | 25.4초 |
| 표준편차 | 15.3초 |
| 최소 | 11.9초 |
| 최대 | 130.9초 |
| 60초 초과 | 1건 (1.3%) |
| 타임아웃 (300초) | 0건 |

---

## 부록: 수정 파일 목록

| 파일 | 변경 항목 |
|------|----------|
| `rag/utils/prompts.py` | P1, P2, P3 — 프롬프트 grounding/focus/synthesis 강화 |
| `rag/utils/config/settings.py` | P4, P5, P6, P8, P9 — temperature, max_tokens, context_length, legal_supplement_k |
| `rag/utils/config/llm.py` | P5 — create_llm에 max_tokens 파라미터 추가 |
| `rag/agents/generator.py` | P5, P7 — max_tokens 전달, ACTION_HINT 분리 |
| `rag/utils/legal_supplement.py` | P8 — 검색 범위 확대 |
| `rag/evaluation/ragas_evaluator.py` | strictness=1 적용 (채점 속도 개선) |
