# RAGAS V4 개선 효과 보고서

> 평가일: 2026-02-22
> 평가 모델: **gpt-4.1-mini** (RAGAS 채점용)
> 데이터셋: `qa_test/ragas_dataset_v4.jsonl` (80문항, ground_truth 포함)
> 임베딩/리랭킹: RunPod GPU (BAAI/bge-m3 + bge-reranker-base)
> 결과 파일: `rag/evaluation/results/ragas_v4_improved_v2.json`

---

## 1. 개선 전후 비교

| 메트릭 | 개선 전 | 개선 후 | 변화 | 평가 |
|--------|---------|---------|------|------|
| **Faithfulness** | 0.4723 | **0.5131** | **+0.041** | 개선 |
| **Answer Relevancy** | 0.6752 | 0.6494 | -0.026 | 소폭 하락 |
| **Context Precision** | 0.6567 | 0.6584 | +0.002 | 변동 없음 |
| **Context Recall** | 0.6023 | 0.5712 | -0.031 | 소폭 하락 |

- 전체 80문항 중 타임아웃: **0건** (100% 응답 성공)
- 평균 응답시간: **27.9초** (개선 전 29.6초에서 단축)

---

## 2. 실패 케이스 변화 (핵심 지표)

| 실패 유형 | 개선 전 | 개선 후 | 변화 | 평가 |
|----------|---------|---------|------|------|
| **Faithfulness = 0** (완전 불일치) | 7건 | **3건** | **-4건** | 크게 개선 |
| **Faithfulness < 0.3** (심각한 불일치) | 21건 | **15건** | **-6건** | 개선 |
| **Answer Relevancy = 0** (무관련 답변) | 6건 | 11건 | +5건 | 악화 |
| **Context Precision = 0** (검색 실패) | 6건 | **4건** | -2건 | 소폭 개선 |

### Faithfulness 개선 (긍정적)
- F=0 케이스가 **7건 → 3건**으로 감소 (57% 감소)
- F<0.3 케이스가 **21건 → 15건**으로 감소 (29% 감소)
- 프롬프트에 추가한 "숫자/비율 날조 금지", "일반론 금지" 규칙이 LLM의 자체 지식 사용을 억제하는 효과를 보임

### Answer Relevancy 악화 (부정적)
- AR=0 케이스가 **6건 → 11건**으로 증가
- 원인 분석:
  - "정보를 찾을 수 없습니다" → "전문가 상담을 권합니다"로 변경했으나, RAGAS가 여전히 **noncommittal**(회피 답변)로 분류
  - 프롬프트 강화로 LLM이 컨텍스트에 없는 정보를 거부 → 답변이 짧아지거나 부분 답변만 제공 → 관련성 점수 하락
  - **Faithfulness vs Answer Relevancy 트레이드오프**: 자체 지식 사용을 금지하면 답변 충실도는 올라가지만, 정보가 부족할 때 답변 관련성은 떨어짐

---

## 3. 점수 분포 분석

### Faithfulness (사실 충실도) — 개선됨

| 구간 | 개선 전 | 개선 후 | 변화 |
|------|---------|---------|------|
| 0.0 (완전 불일치) | 7 (8.8%) | **3 (3.8%)** | -4건 |
| 0.01~0.29 | 14 (17.5%) | **12 (15.0%)** | -2건 |
| 0.30~0.49 | 18 (22.5%) | **15 (18.8%)** | -3건 |
| 0.50~0.69 | 24 (30.0%) | **28 (35.0%)** | +4건 |
| 0.70~0.89 | 14 (17.5%) | **16 (20.0%)** | +2건 |
| 0.90~1.00 | 3 (3.8%) | 1 (1.2%) | -2건 |

**분포가 전체적으로 오른쪽(높은 점수)으로 이동.** 0.50~0.89 구간이 38건 → 44건으로 증가.

### Answer Relevancy (답변 관련성)

| 구간 | 개선 전 | 개선 후 | 변화 |
|------|---------|---------|------|
| 0.0 (무관련) | 6 (7.5%) | 11 (13.8%) | +5건 |
| 0.01~0.29 | 0 (0.0%) | 0 (0.0%) | - |
| 0.30~0.49 | 2 (2.5%) | 1 (1.2%) | -1건 |
| 0.50~0.69 | 26 (32.5%) | **14 (17.5%)** | -12건 |
| 0.70~0.89 | 44 (55.0%) | **51 (63.7%)** | +7건 |
| 0.90~1.00 | 2 (2.5%) | 2 (2.5%) | - |

**양극화 현상**: 0.0 케이스가 늘었지만, 0.70~0.89 구간이 44건 → 51건으로 증가. 답변의 질이 "잘 되거나 / 아예 안 되거나"로 갈림.

### Context Precision / Context Recall — 거의 변동 없음

검색 파이프라인(legal supplement 트리거 확대, 도메인 키워드 추가)의 효과는 미미함. 근본 원인은 **벡터DB에 해당 데이터 자체가 부재**하기 때문.

---

## 4. 적용된 변경 사항

### Phase 1: 프롬프트 강화 (5개 프롬프트 전부 적용)

| 변경 항목 | 대상 | 목적 |
|----------|------|------|
| "정보 없음" 표현 변경 | 4개 도메인 + 멀티도메인 | "해당 정보를 찾을 수 없습니다" → "이 부분은 제공된 자료에서 확인할 수 없어 전문가 상담을 권합니다" |
| 핵심 키워드 보존 규칙 | 4개 도메인 + 멀티도메인 | "질문의 핵심 키워드를 답변에 반드시 포함하세요" |
| 부분 답변 우선 규칙 | 4개 도메인 + 멀티도메인 | "답변 전체를 '정보를 찾을 수 없습니다'로 대체하지 마세요" |
| 절대 금지 사항 강화 | 4개 도메인 + 멀티도메인 | 숫자/비율 날조 금지, 일반론 금지 추가 |
| 도메인별 균형 규칙 | 멀티도메인 | "각 도메인 답변의 분량을 균등하게 배분하세요" |

### Phase 2: 검색 파이프라인 개선

| 변경 항목 | 파일 | 내용 |
|----------|------|------|
| **Legal supplement ~법 패턴** | `legal_supplement.py` | 정규식 `[가-힣]{2,}법`으로 구체적 법률명 자동 감지 (산업안전보건법, 건설산업기본법 등) |
| **Legal supplement 키워드 확대** | `legal_supplement.py` | "개인정보보호법", "산업안전보건법", "건설산업기본법", "의무", "자격요건" 추가 |
| **도메인 키워드 확대** | `domain_data.py` | finance_tax에 "영세율", "면세", "비과세", "스톡옵션", "보험료", "인건비" 추가 |
| **도메인 키워드 확대** | `domain_data.py` | hr_labor에 "일용직", "아르바이트", "요양보호사", "안전보건교육", "퇴직공제", "통상임금" 추가 |
| **도메인 키워드 확대** | `domain_data.py` | law_common에 "개인정보보호법", "개인정보" 추가 |

---

## 5. Faithfulness=0 잔존 케이스 (3건)

| 질문 (요약) | AR | CP | CR | 원인 추정 |
|------------|-----|-----|-----|----------|
| 전기공사 일용직 퇴직공제부금, 원천징수 | 0.74 | 0.33 | 0.00 | CR=0: 필요 문서 미검색 |
| 시니어케어 요양보호사 인건비 세무처리 | 0.85 | 0.33 | 0.67 | 인건비 세무 데이터 부재 |
| 건강기능식품 상표 등록, 이전 비용 | 0.92 | 0.58 | 0.18 | CR 낮음: 상표 이전 데이터 부족 |

**공통 패턴**: 모두 **벡터DB에 해당 데이터가 없거나 부족**(CR이 0.0~0.67). 프롬프트 강화만으로는 해결 불가.

---

## 6. Answer Relevancy=0 증가 원인 분석 (11건)

| 유형 | 건수 | 설명 |
|------|------|------|
| **회피 답변 (noncommittal)** | ~6건 | 프롬프트 강화로 자체 지식 사용 거부 → 답변이 짧아지거나 "확인할 수 없어 전문가 상담 권합니다" 비율 증가 → RAGAS가 noncommittal로 판정 |
| **검색 실패 + 부분 답변** | ~3건 | CP/CR이 낮아 의미있는 답변 생성 불가 |
| **멀티도메인 불균형** | ~2건 | 한 도메인만 답변하고 나머지 도메인은 "확인 불가" 처리 |

**핵심 인사이트**: Faithfulness를 높이려면 자체 지식 사용을 금지해야 하는데, 이는 데이터가 부족한 질문에서 Answer Relevancy를 떨어뜨리는 **트레이드오프**를 발생시킴.

---

## 7. 응답 성능 비교

| 지표 | 개선 전 | 개선 후 | 변화 |
|------|---------|---------|------|
| 평균 응답시간 | 29.6초 | **27.9초** | -1.7초 |
| 중앙값 | 25.4초 | **26.5초** | +1.1초 |
| 표준편차 | 15.3초 | **10.8초** | -4.5초 |
| 최소 | 11.9초 | **9.9초** | -2.0초 |
| 최대 | 130.9초 | **58.8초** | **-72.1초** |
| 60초 초과 | 1건 | **0건** | -1건 |
| 타임아웃 | 0건 | 0건 | - |

**응답 안정성 크게 개선**: 최대 응답시간이 130초 → 59초로 절반 이하로 줄었고, 표준편차도 15초 → 11초로 감소.

---

## 8. 결론 및 향후 방향

### 이번 개선의 성과
1. **Faithfulness 실패 대폭 감소**: F=0이 7건→3건, F<0.3이 21건→15건
2. **응답 안정성 개선**: 최대 응답시간 131초→59초, 편차 감소
3. **검색 실패 소폭 감소**: CP=0이 6건→4건

### 이번 개선의 한계
1. **Answer Relevancy 악화**: AR=0이 6건→11건 (Faithfulness↑ vs AR↓ 트레이드오프)
2. **검색 품질 변동 없음**: CP/CR 평균값 거의 변동 없음 → 데이터 부재가 근본 원인

### 향후 개선 방향 (우선순위 순)

| 우선순위 | 작업 | 예상 효과 | 난이도 |
|---------|------|----------|--------|
| **1** | **finance_tax_db 데이터 보강** — 영세율, 4대보험 비율, 간이과세 기준 등 기초 세무 가이드 추가 | CP/CR +0.05~0.10, F +0.05 | 높음 |
| **2** | **"전문가 상담" 문구 개선** — RAGAS noncommittal 판정을 회피하는 표현 실험 | AR +0.05 | 낮음 |
| **3** | **hr_labor_db 안전보건 데이터 보강** — 산업안전보건법 관련 교육/의무 데이터 추가 | CR +0.02~0.03 | 중간 |
| **4** | **멀티도메인 답변 전략 개선** — 데이터 부족 도메인에서도 최소한의 관련 정보 제공 | AR +0.03 | 중간 |

### 핵심 메시지

> **프롬프트 강화만으로는 한계가 있다.** Faithfulness 개선은 확인되었지만, 벡터DB에 데이터가 없는 질문에서는 프롬프트를 아무리 강화해도 답변 품질을 올릴 수 없다. **다음 단계는 데이터 보강**이 가장 효과적이다.

---

## 부록: 수정 파일 목록

| 파일 | 변경 내용 |
|------|----------|
| `rag/utils/prompts.py` | 5개 프롬프트 강화 (키워드 보존, 부분답변 우선, 절대 금지 강화) |
| `rag/utils/legal_supplement.py` | ~법 패턴 정규식 추가, 키워드 확대 |
| `rag/utils/config/domain_data.py` | 3개 도메인 키워드 확대 (finance_tax, hr_labor, law_common) |
| `rag/evaluation/results/ragas_v4_improved_v2.json` | 개선 후 평가 결과 원본 |
