# ===========================================
# 로컬 개발용 Docker Compose (AWS RDS + Mock RAG)
# - MySQL: SSH 터널 → AWS RDS
# - RAG: Mock 서비스 (경량, 예시 답변)
# - Docker 서비스: nginx, ssh-tunnel, backend, frontend, mock-rag
#
# 사용법: docker compose -f docker-compose.local.yaml up --build
#
# 전제 조건:
#   .ssh/bizi-key.pem       — Bastion EC2 SSH 키
#   .env의 BASTION_HOST     — Bastion EC2 퍼블릭 IP/도메인
#   .env의 MYSQL_HOST       — RDS 엔드포인트 (SSH 터널 내부 포워딩 대상)
#   .env의 MYSQL_USER       — RDS 사용자명
#   .env의 MYSQL_PASSWORD   — RDS 비밀번호
# ===========================================

x-db-env: &db-env
  MYSQL_HOST: ssh-tunnel
  MYSQL_PORT: "3306"
  MYSQL_DATABASE: ${MYSQL_DATABASE:-bizi_db}
  MYSQL_USER: ${MYSQL_USER}
  MYSQL_PASSWORD: ${MYSQL_PASSWORD}

services:
  # Nginx Reverse Proxy
  nginx:
    image: nginx:1.28-alpine
    container_name: bizi-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      frontend:
        condition: service_healthy
      backend:
        condition: service_healthy
    networks:
      - frontend
      - backend

  # SSH 터널 (Bastion EC2 → AWS RDS)
  ssh-tunnel:
    image: alpine:3.21
    container_name: bizi-ssh-tunnel
    restart: unless-stopped
    volumes:
      - ./.ssh/bizi-key.pem:/tmp/bizi-key.pem:ro
      - ssh-known-hosts:/root/.ssh
    entrypoint:
      - sh
      - -c
      - |
        apk add --no-cache openssh-client >/dev/null 2>&1
        mkdir -p /root/.ssh
        cp /tmp/bizi-key.pem /root/.ssh/bizi-key.pem
        chmod 600 /root/.ssh/bizi-key.pem
        echo "Starting SSH tunnel to ${BASTION_HOST} → ${MYSQL_HOST}:${MYSQL_PORT:-3306}"
        exec ssh -N \
          -L 0.0.0.0:3306:${MYSQL_HOST}:${MYSQL_PORT:-3306} \
          -o StrictHostKeyChecking=accept-new \
          -o ServerAliveInterval=30 \
          -o ServerAliveCountMax=3 \
          -o ExitOnForwardFailure=yes \
          -i /root/.ssh/bizi-key.pem \
          ec2-user@${BASTION_HOST}
    healthcheck:
      test: ["CMD-SHELL", "netstat -tln | grep -q ':3306 ' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    expose:
      - "3306"
    networks:
      - backend

  # FastAPI Backend
  backend:
    build: ./backend
    container_name: bizi-backend
    restart: unless-stopped
    volumes:
      - ./backend:/app
    expose:
      - "8000"
    environment:
      <<: *db-env
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-local-dev-secret-key-at-least-32-chars-long}
      ENABLE_TEST_LOGIN: "true"
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      RAG_API_KEY: ${RAG_API_KEY:-}
      RAG_SERVICE_URL: http://mock-rag:8001
    depends_on:
      ssh-tunnel:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    command: >
      sh -c "python -c 'import jwt' || pip install --no-cache-dir 'PyJWT[crypto]>=2.8.0';
      uvicorn main:app --host 0.0.0.0 --port 8000 --reload"
    networks:
      - backend

  # React Frontend (Vite)
  frontend:
    build: ./frontend
    container_name: bizi-frontend
    restart: unless-stopped
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    expose:
      - "5173"
    environment:
      VITE_API_URL: /api
      VITE_RAG_ENABLED: "true"
      VITE_RAG_STREAMING: "true"
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
    depends_on:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:5173/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    command: npm run dev -- --host
    networks:
      - frontend

  # Mock RAG 서비스 (경량, PyTorch 없음)
  mock-rag:
    build: ./mock-rag
    container_name: bizi-mock-rag
    restart: unless-stopped
    expose:
      - "8001"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 5s
    networks:
      - backend

  # LocalStack (S3 로컬 테스트, 필요 시만 실행)
  # 사용법: docker compose -f docker-compose.local.yaml --profile s3 up -d localstack
  localstack:
    image: localstack/localstack:4.0
    container_name: bizi-localstack
    ports:
      - "4566:4566"
    environment:
      - SERVICES=s3
      - DEFAULT_REGION=ap-northeast-2
    volumes:
      - localstack_data:/var/lib/localstack
    profiles:
      - s3

networks:
  frontend:
  backend:

volumes:
  ssh-known-hosts:
  localstack_data:
  frontend_node_modules:
