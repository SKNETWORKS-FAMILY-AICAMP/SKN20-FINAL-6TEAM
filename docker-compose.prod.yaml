# =============================================================================
# Bizi 프로덕션 Docker Compose (직접 RDS 연결 + RunPod 추론)
# 대상: EC2 t3.medium (4GB RAM)
# 컨테이너: nginx, backend, rag, chromadb (4개)
# =============================================================================

# 공통 환경변수 앵커 (backend ↔ rag 공유)
x-db-env: &db-env
  MYSQL_HOST: ${MYSQL_HOST}
  MYSQL_PORT: "3306"
  MYSQL_DATABASE: ${MYSQL_DATABASE:-bizi_db}
  MYSQL_USER: ${MYSQL_USER}
  MYSQL_PASSWORD: ${MYSQL_PASSWORD}

services:
  # --- Nginx (리버스 프록시 + React 정적 파일 서빙) ---
  nginx:
    build:
      context: .
      dockerfile: Dockerfile.nginx
      args:
        VITE_API_URL: /api
        VITE_RAG_ENABLED: ${RAG_ENABLED:-true}
        VITE_RAG_STREAMING: ${VITE_RAG_STREAMING:-true}
        GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
    container_name: bizi-nginx
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/run
      - /tmp
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - certbot_conf:/etc/letsencrypt:ro
      - certbot_www:/var/www/certbot:ro
    depends_on:
      backend:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 128M
    networks:
      - backend

  # --- FastAPI Backend (gunicorn + uvicorn workers) ---
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    container_name: bizi-backend
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp
    volumes:
      - app-logs:/var/log/app
    expose:
      - "8000"
    environment:
      <<: *db-env
      TZ: Asia/Seoul
      ENVIRONMENT: production
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-15}
      REFRESH_TOKEN_EXPIRE_DAYS: ${REFRESH_TOKEN_EXPIRE_DAYS:-7}
      COOKIE_SECURE: ${COOKIE_SECURE:-false}
      COOKIE_SAMESITE: lax
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      ENABLE_TEST_LOGIN: "false"
      RAG_API_KEY: ${RAG_API_KEY:-}
      RAG_SERVICE_URL: http://rag:8001
      # AWS SES 알림 (미설정 시 알림 비활성화)
      AWS_REGION: ${AWS_REGION:-ap-northeast-2}
      SES_FROM: ${SES_FROM:-}
      ALERT_EMAIL_TO: ${ALERT_EMAIL_TO:-}
      ALERT_RESOURCE_THRESHOLD: ${ALERT_RESOURCE_THRESHOLD:-90.0}
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 512M
    networks:
      - backend

  # --- RAG Service (LangChain + RunPod GPU 추론) ---
  rag:
    build:
      context: ./rag
      dockerfile: Dockerfile.prod
    container_name: bizi-rag
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /home/appuser/.cache
    volumes:
      - rag_logs:/app/logs
      - rag_output:/app/output
      - app-logs:/var/log/app
    expose:
      - "8001"
    env_file:
      - .env
    environment:
      <<: *db-env
      TZ: Asia/Seoul
      ENVIRONMENT: production
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      RAG_API_KEY: ${RAG_API_KEY:-}
      BIZINFO_API_KEY: ${BIZINFO_API_KEY:-}
      KSTARTUP_API_KEY: ${KSTARTUP_API_KEY:-}
      TAVILY_API_KEY: ${TAVILY_API_KEY:-}
      UPSTAGE_API_KEY: ${UPSTAGE_API_KEY:-}
      # ChromaDB 서버 연결
      CHROMA_HOST: chromadb
      CHROMA_PORT: "8000"
      CHROMA_AUTH_TOKEN: ${CHROMA_AUTH_TOKEN:-}
      # RAG 검색 설정
      ENABLE_HYBRID_SEARCH: ${ENABLE_HYBRID_SEARCH:-true}
      ENABLE_RERANKING: ${ENABLE_RERANKING:-true}
      ENABLE_DOMAIN_REJECTION: ${ENABLE_DOMAIN_REJECTION:-true}
      ENABLE_LLM_EVALUATION: ${ENABLE_LLM_EVALUATION:-true}
      ENABLE_LEGAL_SUPPLEMENT: ${ENABLE_LEGAL_SUPPLEMENT:-true}
      ENABLE_VECTOR_DOMAIN_CLASSIFICATION: ${ENABLE_VECTOR_DOMAIN_CLASSIFICATION:-true}
      ENABLE_LLM_DOMAIN_CLASSIFICATION: ${ENABLE_LLM_DOMAIN_CLASSIFICATION:-false}
      # RunPod GPU 추론
      EMBEDDING_PROVIDER: ${EMBEDDING_PROVIDER:-runpod}
      RUNPOD_API_KEY: ${RUNPOD_API_KEY}
      RUNPOD_ENDPOINT_ID: ${RUNPOD_ENDPOINT_ID}
    depends_on:
      chromadb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 2560M
    networks:
      - backend

  # --- ChromaDB (벡터 데이터베이스 서버) ---
  chromadb:
    image: chromadb/chroma:1.5.0
    container_name: bizi-chromadb
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    expose:
      - "8000"
    volumes:
      - ./chroma-data:/data
    environment:
      ANONYMIZED_TELEMETRY: "false"
      CHROMA_SERVER_AUTHN_PROVIDER: ${CHROMA_AUTH_TOKEN:+chromadb.auth.token_authn.TokenAuthenticationServerProvider}
      CHROMA_SERVER_AUTHN_CREDENTIALS: ${CHROMA_AUTH_TOKEN:-}
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/8000'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 768M
    networks:
      - backend

  # --- Certbot (SSL 인증서 발급/갱신, 필요 시만 실행) ---
  certbot:
    image: certbot/certbot
    container_name: bizi-certbot
    volumes:
      - certbot_conf:/etc/letsencrypt
      - certbot_www:/var/www/certbot
    networks:
      - backend

  # --- Batch Announcement Updater (systemd timer로 매일 18:30 실행) ---
  batch-updater:
    build:
      context: .
      dockerfile: Dockerfile.batch
    container_name: bizi-batch-updater
    profiles: ["batch"]
    volumes:
      - ./data:/project/data
      - batch_logs:/project/logs
    environment:
      <<: *db-env
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      BIZINFO_API_KEY: ${BIZINFO_API_KEY:-}
      KSTARTUP_API_KEY: ${KSTARTUP_API_KEY:-}
      CHROMA_HOST: chromadb
      CHROMA_PORT: "8000"
      CHROMA_AUTH_TOKEN: ${CHROMA_AUTH_TOKEN:-}
      EMBEDDING_PROVIDER: runpod
      RUNPOD_API_KEY: ${RUNPOD_API_KEY}
      RUNPOD_ENDPOINT_ID: ${RUNPOD_ENDPOINT_ID}
      S3_BUCKET_NAME: ${S3_BUCKET_NAME:-}
      AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION:-ap-northeast-2}
      # AWS SES 알림 (EC2 Instance Role 자동 인증)
      AWS_REGION: ${AWS_REGION:-ap-northeast-2}
      SES_FROM: ${SES_FROM:-}
      ALERT_EMAIL_TO: ${ALERT_EMAIL_TO:-}
      ENVIRONMENT: batch
    depends_on:
      chromadb:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    deploy:
      resources:
        limits:
          memory: 512M
    networks:
      - backend

  # --- VectorDB 빌드 서비스 (GPU 임베딩, 필요 시만 실행) ---
  # OPENAI_API_KEY 불필요 — 로컬 GPU 임베딩(EMBEDDING_PROVIDER=local) 사용
  vectordb-builder:
    build:
      context: ./rag
      dockerfile: Dockerfile.prod
    container_name: bizi-vectordb-builder
    profiles: ["build"]
    volumes:
      - ./scripts/vectordb:/scripts/vectordb:ro
      - ./data/preprocessed:/data/preprocessed:ro
    environment:
      CHROMA_HOST: chromadb
      CHROMA_PORT: "8000"
      CHROMA_AUTH_TOKEN: ${CHROMA_AUTH_TOKEN:-}
      EMBEDDING_PROVIDER: local
    depends_on:
      chromadb:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 4096M
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    command: ["python", "/scripts/vectordb", "--all"]
    networks:
      - backend

networks:
  backend:

volumes:
  app-logs:
    driver: local
  certbot_conf:
    driver: local
  certbot_www:
    driver: local
  rag_logs:
    driver: local
  rag_output:
    driver: local
  batch_logs:
    driver: local
